---
layout: distill
title: Kriging Interpolation in R
description: An introduction to working with kriging in R with examples
giscus_comments: true
categories: Tutorial
date: 2023-03-08

authors:
  - name: Kenan Li
    url: "https://www.slu.edu/public-health-social-justice/faculty/li-kenan.php"
    affiliations:
      name: Saint Louis University
  

bibliography: 2018-12-22-distill.bib

# Optionally, you can add a table of contents to your post.
# NOTES:
#   - make sure that TOC names match the actual section names
#     for hyperlinks within the post to work correctly.
#   - we may want to automate TOC generation in the future using
#     jekyll-toc plugin (https://github.com/toshimaru/jekyll-toc).
toc:
  - name: Introduction
    # if a section has subsections, you can add them as follows:
    subsections:
      - name: Basic Concepts
      - name: Empirical Semivariogram
      - name: Modeling Semivariogram
      - name: Types of Kriging
  - name: Implementation
    subsections:
      - name: Fitting Semivariogram
      - name: Nugget
      - name: Running Kriging
  - name: Footnotes
  - name: Code Blocks
  - name: Interactive Plots
  - name: Layouts
  - name: Other Typography?
---

## Introduction

Spatial interpolation techniques are used to estimate the values of variables at unsampled locations based on the values of the same variable at sampled locations. One of the popular spatial interpolation techniques used in geostatistics is Kriging interpolation. Kriging interpolation is a powerful statistical method that allows one to predict the values of variables at unsampled locations while also accounting for spatial autocorrelation.

In this tutorial, we will go through the basic concepts of Kriging interpolation, the types of Kriging, and how to implement the method in R using the `gstat` library.

### Basic Concepts

Kriging is based on the assumption that the spatial correlation between observations decreases with distance, and that this correlation can be modeled using a mathematical function.

The basic idea of kriging is to find a set of weights that can be used to combine the observed values at nearby locations to estimate the value at the target location. The weights are chosen to minimize the variance of the estimation error, subject to the constraint that the estimated value is a linear combination of the observed values.

The kriging estimator can be written as:

$$
\hat{Z}(s_0)=\sum_{i=1}^n \lambda_i Z(s_i) \quad\quad (1)
$$

where $$\hat{Z}(s_0)$$ is the estimated value at the target location s, $$Z(s_i)$$ is the observed value at location i, $$\lambda_i$$ is the weight assigned to the observed value at location i, and $$n$$ is the number of observed locations.

The weights are typically chosen to minimize the estimation variance $$\sigma^2$$, which is given by:

$$
min\ \ \ \sigma^2 = E \left[ \hat{Z}(s_0)-\sum_{i=1}^n \lambda_i Z(s_i) \right] \quad\quad (2)
$$

The weights $$\lambda_i$$ are chosen to minimize the estimation variance subject to the constraint that they sum to one:

$$
\sum_{i=1}^n \lambda_i = 1 \quad\quad (3)
$$

### Empirical Semivariogram

Semivariogram is a tool commonly used in geostatistics to analyze spatial autocorrelation in data. It is a measure of the dissimilarity between pairs of values at different locations within a dataset. Semivariogram can provide insights into the spatial structure of data, which can be useful in predicting values at unobserved locations through kriging interpolation.

The empirical semivariogram is defined as the average squared difference between pairs of observations separated by a certain distance or lag, and is expressed mathematically as:

$$
\gamma(h) = \frac{1}{2N(h)} \sum_{i=1}^{n} \sum_{|s_j-s_i| < h} [Z(s_i)-Z(s_j)]^2 \quad\quad (4)
$$

where $$\gamma(h)$$ is the semivariance for a lag distance $$h$$, $$N(h)$$ is the number of pairs of observations separated by the distance $$h$$, and $$Z(s_i)$$ is the value of the variable at location $$s_i$$.

The empirical semivariogram is typically plotted as a function of lag distance, which shows how the dissimilarity between pairs of observations changes as the distance between them increases. The shape of the semivariogram curve can provide insights into the spatial structure of the data.

In kriging interpolation, the semivariogram is used to estimate the spatial autocorrelation of the variable being modeled. The semivariogram model is then used to estimate the variance of the estimation errors $$\sigma^2$$ at unobserved locations, which is used to calculate the kriging weights. The kriging weights are then used to calculate the estimated value at the unobserved location.

### Modeling Semivariogram

Empirical semivariogram does not assume under underlying spatial structure of the data. In order to use semivariogram for spatial prediction through kriging interpolation or other geostatistical techniques, it is necessary to model the spatial autocorrelation structure of the data using a theoretical semivariogram model.

These models typically have a covariance function that describes the expected correlation between pairs of observations at different distances, based on assumptions about the underlying spatial structure of the data. Table 1 listed some commonly used covariance functions.

**Table 1: Some Semivariogram Functions** <d-footnote>$^*$ where $$C(h)$$ is the semivariance at lag distance $$h$$, $$c$$ is the sill (maximum semivariance), $$a$$ is the range (distance at which the semivariance reaches the sill), $$\nu$$ is a smoothness parameter, $$\Gamma(\nu)$$ is the gamma function, and $$K_\nu$$ is the modified Bessel function of the second kind of order $$\nu$$.</d-footnote>

| Name          | Function From | 
| ------------- |:-------------:| 
| Exponential   | $$C(h) = c \left[1 - \exp\left(-\frac{h}{a}\right)\right]$$  | 
| Gaussian      | $$C(h) = c \left[1 - \exp\left(-\frac{h^2}{a^2}\right)\right]$$ |  
| Matérn        | $$C(h) = \frac{\sigma^2}{\Gamma(\nu) 2^{\nu-1}} \left(\frac{\sqrt{2\nu}}{a}h\right)^\nu K_\nu\left(\frac{\sqrt{2\nu}}{a}h\right)$$  |   
| Spherical     | $$C(h) = c \left[1.5 \frac{h}{a} - 0.5 \left(\frac{h}{a}\right)^3\right] \quad \text{for } h \le a$$ |

Fitting a semivariogram model to the empirical semivariogram involves estimating the parameters of the model, such as the sill, range, and smoothness parameter, that best describe the spatial autocorrelation structure of the data. This is typically done through solving a least-squares problem, where the goal is to minimize the sum of the squared differences between the empirical semivariogram and the semivariogram model predictions at different lag distances.

The following steps outline the basic procedure for fitting a semivariogram model to the empirical semivariogram:

1. Calculate the empirical semivariogram for the dataset using Equation 4.

2. Choose a covariance function that is appropriate for the spatial autocorrelation structure of the data. This can be based on visual inspection of the empirical semivariogram, or on prior knowledge of the data.

3. Estimate the parameters of the semivariogram model. This involves finding the values of the model parameters that minimize the sum of the squared differences between the predicted semivariance values from the model and the observed semivariance values from the empirical semivariogram.

4. Evaluate the goodness of fit of the semivariogram model to the empirical semivariogram. This can be done using various statistical measures, such as the coefficient of determination ($$R^2$$), the root mean squared error (RMSE), or the Akaike information criterion (AIC).

5. Use the fitted semivariogram model to make spatial predictions through kriging interpolation or other geostatistical techniques.

It is important to note that the choice of semivariogram model and the method used for parameter estimation can have a significant impact on the accuracy and reliability of the spatial predictions. It is therefore important to carefully evaluate the performance of different semivariogram models and parameter estimation methods before making spatial predictions.

It is also important to note that the covariance function and the empirical semivariogram are two related concepts in geostatistics, but they are not the same thing. The covariance function describes the relationship between two spatial locations in terms of their similarity or dissimilarity. It is a mathematical function that specifies the covariance or correlation between two locations as a function of their distance or lag. The covariance function is typically used in kriging to estimate the unknown value of a variable at an unsampled location as a linear combination of the observed values at nearby locations, weighted by their covariance with the unsampled location. 

The semivariogram, on the other hand, is a measure of spatial dependence or autocorrelation in a variable. It is defined as half the variance of the differences between pairs of values separated by a certain lag or distance. The semivariogram is a graphical representation of the spatial structure of the variable, showing how the similarity between values decreases with increasing distance or lag. The semivariogram is often used in geostatistics to estimate the covariance function, by fitting a model to the empirical semivariogram.

### Types of kriging

There are various types of kriging, including ordinary kriging, simple kriging, and universal kriging, which differ in their assumptions about the mean of the unknown variable and the spatial covariance function.

1. Ordinary kriging:

   Ordinary kriging assumes that the mean of the unknown variable $$\mu$$ is unknown and that the covariance between the variable at any two locations depends only on the distance between the locations (intrisical stationarity). The model assumption can be written as:

   $$Z(s) = \mu + \delta(s) \quad\quad (5)$$ 

   where $$\delta(s)$$ is a zero mean stochastic term, and $$\mu$$ is the unknown mean of the variable. For intrinsically stationary process, Equation 2 can be written as (a detailed proof can be found here<d-cite key="christoffersson2018"></d-cite>):

   $$
   \sigma^2 = 2\sum_{i=1}^{n}w_i\gamma(s_0, s_i) - \sum_{i=1}^{n}\sum_{j=1}^{n}w_iw_j\gamma(s_i, s_j) \quad\quad (6)
   $$

   Using matrix notation and covariance function $$C(s_i, s_j)$$ to model semivariogram $$\gamma(s_i, s_j)$$, the kriging system of equations for ordinary kriging can be written as:

   $$
   \begin{bmatrix}C(s_1, s_1) & C(s_1, s_2) & \cdots & C(s_1, s_n) & 1\\C(s_2, s_1) & C(s_2, s_2) & \cdots & C(s_2, s_n) & 1\\\vdots & \vdots& \ddots & \vdots & \vdots\\C(s_n, s_1) & C(s_n, s_2) & \cdots & C(s_n, s_n) & 1\\1 & 1 & \cdots & 1 & 0\end{bmatrix}\begin{bmatrix}\lambda_1\\\lambda_2\\\vdots\\\lambda_n\\\hat{\mu}\end{bmatrix} = \begin{bmatrix}C(s_1, s_0)\\C(s_2, s_0)\\\vdots\\C(s_n, s_0)\\1\end{bmatrix}
   $$

   where $$\hat{\mu}$$ is the estimated mean of the variable, and the additional row and column of 1's correspond to the constraint that the weights sum to 1 and the assumption that the mean of the variable is unknown. The weights $$\lambda_i$$ are chosen to minimize the estimation variance subject to the constraint that they sum to one.

2. Simple kriging:

   Simple kriging assumes that the mean of the unknown variable is known and that the covariance between the variable at any two locations depends only on the distance between the locations. The kriging system of equations for simple kriging can be written as:

   $$
   \begin{bmatrix}C(s_1, s_1) & C(s_1, s_2) & \cdots & C(s_1, s_n)\\C(s_2, s_1) & C(s_2, s_2) & \cdots & C(s_2, s_n)\\\vdots & \vdots& \ddots & \vdots\\C(s_n, s_1) & C(s_n, s_2) & \cdots & C(s_n, s_n)\end{bmatrix}\begin{bmatrix}\lambda_1\\\lambda_2\\\vdots\\\lambda_n\end{bmatrix} = \begin{bmatrix}C(s_1, s)-\mu\\C(s_2, s)-\mu\\\vdots\\C(s_n, s)-\mu\end{bmatrix}
   $$

   where $$\mu$$ is the known mean of the variable and the weights $$\lambda$$ are chosen to minimize the estimation variance subject to the constraint that they sum to one.

3. Universal kriging:

   Universal kriging assumes that the mean of the unknown variable can be modeled using a known function of the spatial coordinates and/or covariates (drift or trend term), such as a linear or quadratic function. The covariance between the variable at any two locations depends on depends only on the distance between the locations. The universal kriging estimator at an unsampled location $$s$$ is given by:

   $$
   Z(s) = \sum_{j=1}^{p} \beta_j v_j(s) + \delta(s) \quad\quad (7)
   $$

   where $$\beta_j$$ are the coefficients of the drift term in the regression model, and $$v_j(s)$$ is the value of the $j$th covariate at location $$s$$. 

   The kriging system of equations for universal kriging can be written as:

  $$
    \begin{bmatrix}
    C(s_1, s_1) & \cdots & C(s_1, s_n) & v_1(s_1) & \cdots & v_p(s_1) \\
    \vdots & \ddots & \vdots & \vdots & \ddots & \vdots \\
    C(s_n, s_1) & \cdots & C(s_n, s_n) & v_1(s_n) & \cdots & v_p(s_n) \\
    v_1(s_1) & \cdots & v_1(s_n) & 0 & \cdots & 0 \\
    \vdots & \ddots & \vdots & \vdots & \ddots & \vdots \\
    v_p(s_1) & \cdots & v_p(s_n) & 0 & \cdots & 0
    \end{bmatrix}
    \begin{bmatrix}
    \lambda_1 \\
    \vdots \\
    \lambda_n \\
    -\beta_1 \\
    \vdots \\
    -\beta_p
    \end{bmatrix}
    =
    \begin{bmatrix}
    C(s_1,s_0) \\
    \vdots \\
    C(s_n,s_0) \\
    v_1(s_0) \\
    \vdots \\
    v_p(s_0)
    \end{bmatrix}
  $$

   where $$C(s_i, s_j)$$ represents the covariance between locations $$s_i$$ and $$s_j$$ in the presence of a drift term, $$C(s_i,s_0)$$ represents the semivariance between the unsampled location and location $$s_i$$, $$\lambda_i$$ represents the kriging weights for each sampled location, $$\mu$$ represents the kriging estimate of the mean value, $$\beta_j$$ represents the coefficients of the drift term in the regression model, and $$v_j(s_i)$$ represents the value of the $$j$$th covariate at location $$s_i$$.

***

## Implementation

### Fitting Semivariogram

The implementation example used in this task is based on the book "An Introduction to R for Spatial Analysis and Mapping" by Brunsdon and Comber<d-cite key="brunsdoncomber2018"></d-cite>. Before following the example, you must install the `gstat` R library in your R environment. The `gstat` library is designed for geostatistical modeling and spatial data analysis in R, providing a wide range of tools for spatial data exploration, variogram modeling, kriging, and spatial prediction.

We will be using the `fulmar` dataset included in the gstat library to practice kriging interpolation. The `fulmar` dataset contains airborne counts of the sea bird Fulmaris glacialis during August and September of 1998 and 1999 over the Dutch part of the North Sea. The counts are taken along transects corresponding to flight paths of the observation aircraft and are transformed to densities by dividing counts by the area of observation, which is $$0.5 km^2$$.

The codes below plots the kriging semivariogram of the `fulmar` dataset:

{% highlight r %}
# Load the gstat library
library(gstat)

# Load the fulmar dataset from the gstat library
data("fulmar")

# Create a SpatialPointsDataFrame object from the fulmar dataset
# The cbind function combines the x and y coordinates into a matrix, which is used to create the SpatialPointsDataFrame
fulmar.spdf <- SpatialPointsDataFrame(cbind(fulmar$x,fulmar$y), fulmar)

# Calculate the empirical variogram of the 'fulmar' variable in the fulmar.spdf dataset
# The 'fulmar~1' formula specifies the variable to be analyzed and '1' indicates that there are no covariates
# The 'boundaries' argument sets the distance lags for the variogram calculation
evgm <- variogram(fulmar~1,fulmar.spdf, boundaries=seq(0,250000,l=51))

# Fit a variogram model to the experimental variogram
# The 'vgm' function specifies the type of variogram model to be used
# Here, a Matérn model with a sill of 3, a range of 100000 and a nugget of 1 is used
fvgm <- fit.variogram(evgm,vgm(3,"Mat",100000,1))

# Plot the experimental variogram with the fitted variogram model
# The 'model' argument specifies the fitted variogram model to be plotted
plot(evgm,model=fvgm)
{% endhighlight %}

The `variogram()` function computes the empirical variogram, and takes the following key arguments:

- `formula`: A formula specifying the variables to be used in the calculation of the variogram. The formula takes the form `response` ~ `predictor`, where `response` is the variable to be analyzed and `predictor` is an optional covariate or drift term. The covariate can be a numeric or factor variable, and the drift term can be specified as 1 for `ordinary kriging`.
- `data`: A spatial data object containing the variables specified in the formula argument.
- `width`: The maximum lag distance between pairs of sample locations. If not specified, the function will determine the maximum lag distance based on the data.

**Figure 1: Matérn Semivariogram of Fulmar Counts in the North Sea**

<div class="row">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.html path="assets/img/fulmar_variogram.png" title="Matérn Semivariogram of Fulmar Counts in the North Sea" class="img-fluid rounded z-depth-1" %}
    </div>
</div>

### Nugget

In `vgm(3,"Mat",100000,1)`, the `nugget` argumaent refers to the intercept of the variogram at zero distance or lag. It represents the spatial variability that cannot be explained by the spatial autocorrelation in the data, such as measurement error or microscale variation.

The nugget effect is an important concept in variogram modeling because it affects the shape of the variogram and the spatial prediction derived from it. A large nugget effect indicates that there is a high degree of spatial variability at small distances or lags, which can lead to difficulties in spatial interpolation and prediction. On the other hand, a small nugget effect indicates that the spatial variability is primarily driven by spatial autocorrelation, making it easier to predict the value of the variable at unsampled locations.

Variogram models that account for the nugget effect can be used to estimate the spatial correlation structure of the data and to make predictions at unsampled locations based on that structure. Different types of variogram models, such as exponential, Gaussian, and Matérn, incorporate the nugget effect in different ways and may be more appropriate for certain types of data or spatial structures.

### Running Kriging


```r
# Load the gstat library
library(gstat)

# Load the fulmar dataset
data(fulmar)

# Create a SpatialPointsDataFrame object from the fulmar dataset
fulmar.spdf <- SpatialPointsDataFrame(cbind(fulmar$x,fulmar$y), fulmar)

# Compute the variogram for the log(density) variable
v <- variogram(log(density) ~ 1, fulmar.spdf)

# Plot the variogram
plot(v, main = "Variogram of Log(Density)", xlab = "Distance", ylab = "Semi-Variance")
```
***

## Footnotes

Just wrap the text you would like to show up in a footnote in a `<d-footnote>` tag.
The number of the footnote will be automatically generated.<d-footnote>This will become a hoverable footnote.</d-footnote>

***

## Code Blocks

Syntax highlighting is provided within `<d-code>` tags.
An example of inline code snippets: `<d-code language="html">let x = 10;</d-code>`.
For larger blocks of code, add a `block` attribute:

<d-code block language="javascript">
  var x = 25;
  function(x) {
    return x * x;
  }
</d-code>

**Note:** `<d-code>` blocks do not look good in the dark mode.
You can always use the default code-highlight using the `highlight` liquid tag:

{% highlight javascript %}

var x = 25;
function(x) {
  return x * x;
}
{% endhighlight %}

***

## Interactive Plots

You can add interative plots using plotly + iframes :framed_picture:

<div class="l-body">
  <iframe src="{{ '/assets/plotly/demo.html' | relative_url }}" frameborder='0' scrolling='no' height="500px" width="100%" style="border: 1px dashed grey;"></iframe>
</div>

The plot must be generated separately and saved into an HTML file.
To generate the plot that you see above, you can use the following code snippet:

{% highlight python %}
import pandas as pd
import plotly.express as px
df = pd.read_csv(
  'https://raw.githubusercontent.com/plotly/datasets/master/earthquakes-23k.csv'
)
fig = px.density_mapbox(
  df,
  lat='Latitude',
  lon='Longitude',
  z='Magnitude',
  radius=10,
  center=dict(lat=0, lon=180),
  zoom=0,
  mapbox_style="stamen-terrain",
)
fig.show()
fig.write_html('assets/plotly/demo.html')
{% endhighlight %}

***

## Layouts

The main text column is referred to as the body.
It is the assumed layout of any direct descendants of the `d-article` element.

<div class="fake-img l-body">
  <p>.l-body</p>
</div>

For images you want to display a little larger, try `.l-page`:

<div class="fake-img l-page">
  <p>.l-page</p>
</div>

All of these have an outset variant if you want to poke out from the body text a little bit.
For instance:

<div class="fake-img l-body-outset">
  <p>.l-body-outset</p>
</div>

<div class="fake-img l-page-outset">
  <p>.l-page-outset</p>
</div>

Occasionally you’ll want to use the full browser width.
For this, use `.l-screen`.
You can also inset the element a little from the edge of the browser by using the inset variant.

<div class="fake-img l-screen">
  <p>.l-screen</p>
</div>
<div class="fake-img l-screen-inset">
  <p>.l-screen-inset</p>
</div>

The final layout is for marginalia, asides, and footnotes.
It does not interrupt the normal flow of `.l-body` sized text except on mobile screen sizes.

<div class="fake-img l-gutter">
  <p>.l-gutter</p>
</div>

***

## Other Typography?

Emphasis, aka italics, with *asterisks* (`*asterisks*`) or _underscores_ (`_underscores_`).

Strong emphasis, aka bold, with **asterisks** or __underscores__.

Combined emphasis with **asterisks and _underscores_**.

Strikethrough uses two tildes. ~~Scratch this.~~

1. First ordered list item
2. Another item
⋅⋅* Unordered sub-list.
1. Actual numbers don't matter, just that it's a number
⋅⋅1. Ordered sub-list
4. And another item.

⋅⋅⋅You can have properly indented paragraphs within list items. Notice the blank line above, and the leading spaces (at least one, but we'll use three here to also align the raw Markdown).

⋅⋅⋅To have a line break without a paragraph, you will need to use two trailing spaces.⋅⋅
⋅⋅⋅Note that this line is separate, but within the same paragraph.⋅⋅
⋅⋅⋅(This is contrary to the typical GFM line break behaviour, where trailing spaces are not required.)

* Unordered list can use asterisks
- Or minuses
+ Or pluses

[I'm an inline-style link](https://www.google.com)

[I'm an inline-style link with title](https://www.google.com "Google's Homepage")

[I'm a reference-style link][Arbitrary case-insensitive reference text]

[I'm a relative reference to a repository file](../blob/master/LICENSE)

[You can use numbers for reference-style link definitions][1]

Or leave it empty and use the [link text itself].

URLs and URLs in angle brackets will automatically get turned into links.
http://www.example.com or <http://www.example.com> and sometimes
example.com (but not on Github, for example).

Some text to show that the reference links can follow later.

[arbitrary case-insensitive reference text]: https://www.mozilla.org
[1]: http://slashdot.org
[link text itself]: http://www.reddit.com

Here's our logo (hover to see the title text):

Inline-style:
![alt text](https://github.com/adam-p/markdown-here/raw/master/src/common/images/icon48.png "Logo Title Text 1")

Reference-style:
![alt text][logo]

[logo]: https://github.com/adam-p/markdown-here/raw/master/src/common/images/icon48.png "Logo Title Text 2"

Inline `code` has `back-ticks around` it.

```javascript
var s = "JavaScript syntax highlighting";
alert(s);
```

```python
s = "Python syntax highlighting"
print s
```

```r
a <- fulmar_variogram
```

```
No language indicated, so no syntax highlighting.
But let's throw in a <b>tag</b>.
```

Colons can be used to align columns.

| Tables        | Are           | Cool  |
| ------------- |:-------------:| -----:|
| col 3 is      | right-aligned | $1600 |
| col 2 is      | centered      |   $12 |
| zebra stripes | are neat      |    $1 |

There must be at least 3 dashes separating each header cell.
The outer pipes (|) are optional, and you don't need to make the
raw Markdown line up prettily. You can also use inline Markdown.

Markdown | Less | Pretty
--- | --- | ---
*Still* | `renders` | **nicely**
1 | 2 | 3

> Blockquotes are very handy in email to emulate reply text.
> This line is part of the same quote.

Quote break.

> This is a very long line that will still be quoted properly when it wraps. Oh boy let's keep writing to make sure this is long enough to actually wrap for everyone. Oh, you can *put* **Markdown** into a blockquote.


Here's a line for us to start with.

This line is separated from the one above by two newlines, so it will be a *separate paragraph*.

This line is also a separate paragraph, but...
This line is only separated by a single newline, so it's a separate line in the *same paragraph*.